// arduino nano old west pistol dual game

// --- LIBRARIES ---
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// ---OLED INITIALISING ---
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 32
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// --- BUTTON/BUZZER---
#define BUTTON_PIN 3
#define BUZZER_PIN 2

// ---SONG STRUCT---
struct Note {
  int freq;
  int duration;
};

// PLAYER COWBOY FRAMES
extern const unsigned char cowboy_walk[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xf2, 0x00, 0x00, 0xfe, 0x00, 0x01, 0xf8, 0x00, 0x07, 0x88, 0x00, 0x00, 0x88, 0x00, 0x00, 0x98, 
	0x00, 0x00, 0x70, 0x00, 0x00, 0x10, 0x00, 0x00, 0x08, 0x00, 0x00, 0x18, 0x00, 0x00, 0x7e, 0x00, 
	0x01, 0x8b, 0x00, 0x01, 0x09, 0x00, 0x01, 0x09, 0x00, 0x03, 0x09, 0x80, 0x00, 0x10, 0x00, 0x00, 
	0x30, 0x00, 0x00, 0x38, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x64, 0x00, 0x00, 0x44, 0x00, 0x00, 0x66, 
	0x00, 0x00, 0xcc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
extern const unsigned char cowboy_turn[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 
	0x78, 0x00, 0x03, 0xf8, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x8f, 0x00, 0x00, 0x88, 0x00, 0x00, 0xc8, 
	0x00, 0x00, 0x70, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x82, 0x00, 0x03, 0xe1, 0xf8, 
	0x06, 0xb3, 0x80, 0x04, 0x8e, 0x80, 0x04, 0x80, 0x00, 0x0c, 0x80, 0x00, 0x00, 0x40, 0x00, 0x00, 
	0x60, 0x00, 0x00, 0xe0, 0x00, 0x01, 0xa0, 0x00, 0x01, 0x30, 0x00, 0x01, 0x10, 0x00, 0x03, 0x30, 
	0x00, 0x01, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
extern const unsigned char cowboy_shot[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x78, 0x00, 0x03, 0xf8, 0x00, 0x00, 0xfc, 0x00, 0x00, 
	0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x88, 0x00, 0x00, 0x88, 0x00, 0x00, 0xc8, 
	0x00, 0x00, 0x70, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 0x03, 0xe0, 0x00, 
	0x06, 0xb0, 0x00, 0x04, 0x8f, 0x00, 0x04, 0x80, 0x00, 0x0c, 0x80, 0x00, 0x00, 0x40, 0x00, 0x00, 
	0x60, 0x40, 0x00, 0xe0, 0x3e, 0x01, 0xa0, 0x70, 0x01, 0x30, 0x10, 0x01, 0x10, 0x00, 0x03, 0x30, 
	0x00, 0x01, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// BOT COWBOY FRAMES
extern const unsigned char cowboy_walk_R[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x9e, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x23, 0xc0, 0x00, 0x22, 0x00, 0x00, 0x32,
  0x00, 0x00, 0x1c, 0x00, 0x00, 0x10, 0x00, 0x00, 0x20, 0x00, 0x00, 0x30, 0x00, 0x00, 0xfc, 0x00, 
  0x01, 0xa3, 0x00, 0x01, 0x21, 0x00, 0x01, 0x21, 0x00, 0x03, 0x21, 0x80, 0x00, 0x10, 0x00, 0x00, 
  0x18, 0x00, 0x00, 0x38, 0x00, 0x00, 0x68, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x44, 0x00, 0x00, 0xcc, 
  0x00, 0x00, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
extern const unsigned char cowboy_turn_R[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x3c, 0x80, 0x00, 0x3f, 0x80, 0x00, 0x7e, 0x00, 0x01, 0xe2, 0x00, 0x00, 0x22, 0x00, 0x00, 0x26, 
	0x00, 0x00, 0x1c, 0x00, 0x00, 0x04, 0x00, 0x00, 0x02, 0x00, 0x00, 0x82, 0x00, 0x3f, 0x0f, 0x80, 
	0x03, 0x9a, 0xc0, 0x02, 0xe2, 0x40, 0x00, 0x02, 0x40, 0x00, 0x02, 0x60, 0x00, 0x04, 0x00, 0x00, 
	0x0c, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x19, 0x00, 0x00, 0x11, 0x00, 0x00, 0x19, 
	0x80, 0x00, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
extern const unsigned char cowboy_shot_R[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x80, 0x00, 0x3f, 0x80, 0x00, 0x7e, 0x00, 0x01, 
	0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x22, 0x00, 0x00, 0x22, 0x00, 0x00, 0x26, 
	0x00, 0x00, 0x1c, 0x00, 0x00, 0x04, 0x00, 0x00, 0x02, 0x00, 0x00, 0x02, 0x00, 0x00, 0x0f, 0x80, 
	0x00, 0x1a, 0xc0, 0x01, 0xe2, 0x40, 0x00, 0x02, 0x40, 0x00, 0x02, 0x60, 0x00, 0x04, 0x00, 0x04, 
	0x0c, 0x00, 0xf8, 0x0e, 0x00, 0x1c, 0x0b, 0x00, 0x10, 0x19, 0x00, 0x00, 0x11, 0x00, 0x00, 0x19, 
	0x80, 0x00, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// MENU SCREEN BITMAP
extern const unsigned char testBitmap[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x31, 0x91, 0x71, 0x91, 0x0e, 0xe8, 0xa5, 0x06, 0x7c, 0xce, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x4a, 0x51, 0x4a, 0x51, 0x10, 0x4d, 0xa5, 0x09, 0x11, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x42, 0x55, 0x72, 0x4e, 0x0c, 0x4a, 0xa5, 0x0f, 0x11, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x4a, 0x5b, 0x4a, 0x44, 0x02, 0x48, 0xa5, 0x09, 0x11, 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x31, 0x91, 0x71, 0x84, 0x1c, 0xe8, 0x99, 0xe9, 0x10, 0xc9, 0x00, 0x00, 0x7c, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa3, 0x08, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x4c, 0x08, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x30, 0x04, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 
	0x01, 0xce, 0x79, 0xce, 0x3e, 0x60, 0xef, 0x99, 0xcf, 0x80, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 
	0x01, 0x29, 0x42, 0x10, 0x08, 0x91, 0x02, 0x25, 0x22, 0x00, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 
	0x01, 0xce, 0x71, 0x8c, 0x08, 0x90, 0xc2, 0x3d, 0xc2, 0x00, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 
	0x01, 0x0a, 0x40, 0x42, 0x08, 0x90, 0x22, 0x25, 0x42, 0x00, 0x03, 0x82, 0x00, 0x04, 0x00, 0x00, 
	0x01, 0x09, 0x7b, 0x9c, 0x08, 0x61, 0xc2, 0x25, 0x22, 0x00, 0x04, 0x72, 0x00, 0x04, 0x06, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x0e, 0x00, 0x06, 0x19, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x06, 0x00, 0x1a, 0x61, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x05, 0x81, 0xe1, 0x82, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x7e, 0x01, 0x04, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x00, 0x1e, 0x08, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x01, 0xe4, 0x30, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xfe, 0x08, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x13, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x2c, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x07, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// COWBOY DIMENSIONS (sprite)
const int SPRITE_W = 23;
const int SPRITE_H = 32;

//  GAME STATES
enum GameState {
  START_SCREEN,
  WALKING,
  WAIT_TO_SHOOT,
  PLAYER_WINS,
  PLAYER_LOSES,
  TIE_SCREEN,
  STATE_EARLY
};

GameState state = START_SCREEN;

//  TIMING SETUP
unsigned long stateStartTime = 0;
unsigned long botShootTime = 0;
unsigned long playerShootTime = 0;


//  SYSTEM FOR STEPS
int totalSteps = 0;
int currentStep = 0;
unsigned long lastStepTime = 0;
unsigned long stepInterval = 400;

// Cowboy positions
int leftCowboyX = 64;
int rightCowboyX = 64;

//  BUTTON DEBOUNCE
bool buttonPressed() {
  static unsigned long lastPress = 0;
  if (digitalRead(BUTTON_PIN) == LOW) {
    if (millis() - lastPress > 200) {
      lastPress = millis();
      return true;
    }
  }
  return false;
}


// SONG ENGINE - enigine is needed bc delay blocks button from being used as it chokes smthn
Note startSong[] = {
  {233,600},{294,400},{311,600},{294,400},
  {262,800},{0,300},{415,600},{349,500},
  {294,600},{231,1200}
};
int startLen = 10;

Note duelSong[] = {
  {220,150},{247,150},{262,300}
};
int duelLen = 3;

Note winSong[] = {
  {523,250},{587,250},{659,300},{784,350},
  {659,250},{523,300},{880,300},{784,300},
  {659,300},{523,600}
};
int winLen = 10;

Note loseSong[] = {
  {130,500}
};
int loseLen = 1;

Note earlySong[] = {
  {130,500}
};
int earlyLen = 1;

Note tieSong[] = {
  {300,200},{0,200},{300,200}
};
int tieLen = 3;

Note* currentSong = nullptr;
int currentSongLength = 0;
int songIndex = 0;
unsigned long lastNoteTime = 0;
bool songPlaying = false;

void playSong(Note* song, int length) {
  currentSong = song;
  currentSongLength = length;
  songIndex = 0;
  lastNoteTime = millis();
  songPlaying = true;

  if (song[0].freq > 0) tone(BUZZER_PIN, song[0].freq);
  else noTone(BUZZER_PIN);
}

void stopSong() {
  songPlaying = false;
  noTone(BUZZER_PIN);
}

void updateSong() {
  if (!songPlaying) return;

  if (millis() - lastNoteTime >= (unsigned long)currentSong[songIndex].duration) {
    songIndex++;
    lastNoteTime = millis();

    if (songIndex >= currentSongLength) {
      stopSong();
      return;
    }

    if (currentSong[songIndex].freq > 0)
      tone(BUZZER_PIN, currentSong[songIndex].freq);
    else
      noTone(BUZZER_PIN);
  }
}

//  SPRITE AND MENU DRAW HELPERS
void drawBitmapFullStart() {
  display.clearDisplay();
  display.drawBitmap(0, 0, testBitmap, 128, 32, 1);
  display.display();
}

void drawCowboyLeft(int x, int y, const unsigned char* frame) {
  display.drawBitmap(x, y, frame, SPRITE_W, SPRITE_H, WHITE);
}

void drawCowboyRight(int x, int y, const unsigned char* frame) {
  display.drawBitmap(x, y, frame, SPRITE_W, SPRITE_H, WHITE);
}

void drawWalkAnimation() {
  display.clearDisplay();

  drawCowboyLeft(leftCowboyX - SPRITE_W, 0, cowboy_walk);
  drawCowboyRight(rightCowboyX, 0, cowboy_walk_R);

  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(62, 0);
  display.print(totalSteps - currentStep);
  display.display();
}

void drawTurnPose() {
  display.clearDisplay();
  drawCowboyLeft(leftCowboyX - SPRITE_W, 0, cowboy_turn);
  drawCowboyRight(rightCowboyX, 0, cowboy_turn_R);
  display.display();
}

void drawPlayerShootsPose() {
  display.clearDisplay();
  drawCowboyLeft(leftCowboyX - SPRITE_W, 0, cowboy_shot);
  drawCowboyRight(rightCowboyX, 0, cowboy_turn_R);
  display.display();
}

void drawBotShootsPose() {
  display.clearDisplay();
  drawCowboyLeft(leftCowboyX - SPRITE_W, 0, cowboy_turn);
  drawCowboyRight(rightCowboyX, 0, cowboy_shot_R);
  display.display();
}

void drawTie() {
  display.clearDisplay();
  drawCowboyLeft(leftCowboyX - SPRITE_W, 0, cowboy_shot);
  drawCowboyRight(rightCowboyX, 0, cowboy_shot_R);
  display.display();
}

void drawTextScreen(const char* text) {
  display.setTextSize(1);
  display.setTextColor(WHITE);

  int16_t x, y;
  uint16_t w, h;
  display.getTextBounds(text, 0, 0, &x, &y, &w, &h);

  int16_t cx = (SCREEN_WIDTH - w) / 2;
  int16_t cy = (SCREEN_HEIGHT - h) / 2;

  display.setCursor(cx, cy);
  display.print(text);
  display.display();
}

//  SETUP
void setup() {
  // INPUTS/OUTPUTS
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(BUZZER_PIN, OUTPUT);
  
  // OLED INITIALISE
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.clearDisplay();
  display.display();

  playSong(startSong, startLen);
}

//  MAIN LOOP
void loop() {
  updateSong();

  switch (state) {
  case START_SCREEN:
    drawBitmapFullStart();

    if (buttonPressed()) { // GAME START SEQUENCE
      stopSong();
      totalSteps = random(3, 6);
      currentStep = 0;
      leftCowboyX = 64;
      rightCowboyX = 64;
      state = WALKING;
      stateStartTime = millis();
    }
    break;

  case WALKING:
    if (buttonPressed()) { // WALKING STAGE
      stopSong();
      playSong(earlySong, earlyLen);
      state = STATE_EARLY;
      break;
    }

    if (millis() - lastStepTime > stepInterval && currentStep < totalSteps) {
      lastStepTime = millis();
      currentStep++;
      leftCowboyX -= 6;
      rightCowboyX += 6;
    }

    drawWalkAnimation();

    if (currentStep >= totalSteps) { // TURN STAGE
      drawTurnPose();
      playSong(duelSong, duelLen);
      state = WAIT_TO_SHOOT;
      botShootTime = millis() + random(200, 400); // adjust difficulty here
    }
    break;

  case WAIT_TO_SHOOT: // win/lose/tie/early states
    if (buttonPressed()) {
      stopSong();
      playerShootTime = millis();

      if (abs((long)(playerShootTime - botShootTime)) < 40) {
        drawTie();
        playSong(tieSong, tieLen);
        state = TIE_SCREEN;
      }
      else if (playerShootTime < botShootTime) {
        drawBotShootsPose();
        playSong(winSong, winLen);
        state = PLAYER_WINS;
      }
      else {
        drawPlayerShootsPose();
        playSong(loseSong, loseLen);
        state = PLAYER_LOSES;
      }
    }

    if (millis() > botShootTime && state == WAIT_TO_SHOOT) {
      drawPlayerShootsPose();
      playSong(loseSong, loseLen);
      state = PLAYER_LOSES;
    }
    break;

  case PLAYER_WINS: // case displays
    drawTextScreen("WIN");
    if (buttonPressed()) {
      stopSong();
      playSong(startSong, startLen);
      state = START_SCREEN;
    }
    break;

  case PLAYER_LOSES:
    drawTextScreen("LOSE");
    if (buttonPressed()) {
      stopSong();
      playSong(startSong, startLen);
      state = START_SCREEN;
    }
    break;

  case TIE_SCREEN:
    drawTextScreen("TIE");
    if (buttonPressed()) {
      stopSong();
      playSong(startSong, startLen);
      state = START_SCREEN;
    }
    break;

  case STATE_EARLY: // custom for early
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(10,5);
  display.print("DISHONOUR");
  display.display();
    if (buttonPressed()) {
      stopSong();
      playSong(startSong, startLen);
      state = START_SCREEN;
    }
    break;
  }
}
